#include <iostream>
#include <fstream>

#include <radar/units.h>

#include <hussar/hussar.h>
#include <hussar/io/wavefront.h>
#include <hussar/core/frame.h>
#include <hussar/core/mesh.h>
#include <hussar/core/geometry.h>
#include <hussar/core/scene.h>
#include <hussar/core/emitter.h>
#include <hussar/integrators/path.h>

#include <hussar/arch/cpu.h>
#include <hussar/arch/gpu.h>

#include "utils.h"

using namespace std;
using namespace hussar;
using namespace radar;

int main() {
    radar::RFConfig rf;
    
    rf.antennaDelay = 0.43_ns;
    
    rf.startFreq = 77_GHz;
    rf.freqSlope = 60_MHz / 1_us;
    rf.adcRate   = 5_MHz;
    rf.idleTime  = 100_us;
    rf.rampTime  = 60_us;

    radar::FrameConfig frameConfig;
    
    frameConfig.chirpCount      = 128;
    frameConfig.samplesPerChirp = 256;
    frameConfig.channelCount    = 4;

    //

    struct Location {
        std::string label;
        Matrix44f transform;
    };

    std::vector<Location> locations = {
        { "IMG_0231", (Matrix44f() << -0.8726346469868954, 0.024254462604409933, -0.4877709441139639, 4.892457166103613, 0.4848671619517882, -0.07644173219883, -0.8712407800598297, 8.98393090920772, -0.05841753280372814, -0.996779003903179, 0.0549455115447271, 0.5737809837812888, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0232", (Matrix44f() << -0.9579936437279385, 0.01937694322054484, -0.28613408159164727, 3.963883550237067, 0.2835843227164401, -0.08474221990606651, -0.955195628169879, 8.47059939688752, -0.04275640871642012, -0.9962144800377174, 0.07568751070589394, 0.6082082278030089, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0233", (Matrix44f() << -0.9881846291599523, 0.03878886697931802, 0.14827866498747613, 2.6417597638020687, -0.15057904406198877, -0.06526993103770025, -0.9864409701506276, 8.544583317253212, -0.02858478933602724, -0.9971134639050836, 0.07033953310777862, 0.5791180005500626, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0234", (Matrix44f() << -0.9017329586322202, 0.05418769576468444, 0.42888385950522373, 1.365807944754348, -0.4315103130434502, -0.05313389491783106, -0.9005418585207488, 8.18968319006702, -0.026010018329981417, -0.9971160829304555, 0.0712951338304315, 0.6292415261793121, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0235", (Matrix44f() << -0.8425125399262041, 0.02495929992478388, 0.5380981819467159, 0.4971564217237129, -0.5386370308190215, -0.05116196160227754, -0.8409831167838482, 7.3300558070851105, 0.0065398086795256435, -0.9983784287695081, 0.05654859741994879, 0.6739028761822358, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0236", (Matrix44f() << -0.5662621308413357, 0.04096421584148025, 0.823206615738432, 0.02099944017986549, -0.8238732330888424, -0.05731682742036641, -0.5638684927305317, 6.447837593020306, 0.024085160883160033, -0.9975152702164296, 0.06620566977439091, 0.7252654449839698, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0237", (Matrix44f() << -0.3905799569468907, 0.05996379677873896, 0.9186139778531803, 0.2164486154570068, -0.9200626828174501, -0.058519145991501174, -0.38737600498634595, 5.583267998329237, 0.030527969439862867, -0.9964837442870322, 0.07802685725809626, 0.773649220095027, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0238", (Matrix44f() << -0.10377929013576737, 0.08323795323964346, 0.9911111451695976, -0.021716703984671272, -0.9936750589034716, -0.05165091075263201, -0.0997098828181332, 4.682578951770694, 0.04289214674154767, -0.9951902464146735, 0.08807177294118104, 0.824191260390186, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0239", (Matrix44f() << 0.18394466269472654, 0.11881656240184564, 0.9757289508696212, -0.12469860226447832, -0.9828239387411108, 0.007203456698198537, 0.18440503151759857, 3.868186390267246, 0.014881750687757045, -0.9928900919591279, 0.1181007992600471, 0.8843898509920083, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0240", (Matrix44f() << 0.3904491588980485, 0.10632721332993457, 0.9144637652861359, 0.000586950506910322, -0.9196151564827213, -0.0014550065027379836, 0.39281782918209934, 2.89138608309001, 0.04309777584825647, -0.9943301296156963, 0.09721201085959419, 0.9289771127831012, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0241", (Matrix44f() << 0.6027508419186255, 0.07587316146426229, 0.7943139718875694, 0.4723600219520961, -0.7970249046767405, 0.009862611185484897, 0.6038659041754523, 1.9275261053980974, 0.037983205386341604, -0.997068699874799, 0.06641749647914395, 0.9761099736170081, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0242", (Matrix44f() << 0.8991302804463547, 0.023060351586735126, 0.43707317347230956, 1.3239570672416774, -0.43759931943523406, 0.028061461231723234, 0.8987321013646729, 1.346925109535669, 0.008460166326935137, -0.9993401696010406, 0.035322103667306266, 1.0145043831762361, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0243", (Matrix44f() << 0.9971334754520509, 0.02288349460672838, 0.07211919167252423, 2.3261649736380168, -0.07294005739955775, 0.037332197399618454, 0.9966373739048046, 1.145846384780247, 0.020114178070794894, -0.9990408663873064, 0.03889430714946068, 0.9994143702915993, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0244", (Matrix44f() << 0.9828402145897505, 0.008265804863545903, -0.18427367976770553, 3.2702716804449494, 0.1843240990573724, -0.005814382890418303, 0.9828483196599014, 1.2119869224101005, 0.007052594689976942, -0.9999489334068822, -0.007238196362182859, 0.9807139316637327, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0245", (Matrix44f() << 0.8558659394774176, 0.0018698822930539576, -0.5171943514605, 3.9769946291429963, 0.5168782149559956, 0.03205260539605437, 0.8554586731053864, 1.7236713256870728, 0.018177033485710918, -0.9994844341096739, 0.026466231808181775, 0.9439877212110158, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0246", (Matrix44f() << 0.6465751795719606, -0.011742072254914068, -0.7627598972813444, 4.515972060208702, 0.7627414283637086, -0.0069390905925966525, 0.6466663455596228, 2.493102022871091, -0.01288606298201731, -0.999906982054285, 0.004469521217688816, 0.9036106165104716, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0247", (Matrix44f() << 0.20336986954125355, -0.005354800585124091, -0.9790873414938358, 5.464576661060417, 0.9787492899046247, -0.025726442935062623, 0.20344035402324107, 2.963121027121549, -0.026277817146144845, -0.9996546784988317, 9.023926807214157e-06, 0.8572071028374011, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0248", (Matrix44f() << -0.0700139025948502, -0.05944786357003937, -0.9957730690073903, 5.808414813665894, 0.9971212905319018, -0.03329683322771879, -0.06812086952615964, 4.215040299026368, -0.029106449653529192, -0.9976759355692426, 0.06160797168064513, 0.8028920447192682, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0249", (Matrix44f() << -0.1570120192575688, -0.01919197497263529, -0.9874101953622468, 5.733055512204251, 0.9875208051124065, -0.015445162746339145, -0.15672940508367791, 5.447949142672047, -0.012242764344922656, -0.9996965114695504, 0.021377550767238993, 0.708956409524601, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0250", (Matrix44f() << -0.6753589867181389, -0.029963421690935924, -0.7368802022171714, 5.749043490786888, 0.7358780070484183, -0.093388851725484, -0.6706430355381645, 6.929061452220901, -0.04872163586638471, -0.9951787355716393, 0.08512042331037091, 0.669080875994362, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0251", (Matrix44f() << -0.8707434887694424, 0.036905217344354986, -0.49035067217083117, 4.274665343374339, 0.49172211850847947, 0.05745866249765915, -0.868854337776772, 7.467965331616833, -0.0038903643984732374, -0.9976655286401079, -0.06817886789981975, 0.5733835619534638, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0252", (Matrix44f() << -0.9840219404138443, 0.03795480929983789, -0.17395474479066636, 3.4302787099752905, 0.1732629218681344, -0.020838337846695268, -0.9846551292617652, 7.768713280563645, -0.040997325399221046, -0.9990621582898633, 0.013929220484666235, 0.6153650775155374, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0253", (Matrix44f() << -0.9992877165148103, 0.01369087257854279, 0.03516560294740165, 2.5951928702799516, -0.03645054561580326, -0.10897041405092608, -0.9933764677028947, 8.66395106964737, -0.009768180328314398, -0.9939507074647151, 0.10939183600006691, 0.5581347088168555, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0254", (Matrix44f() << -0.8784382700597926, 0.022505446684147657, 0.4773255813005476, 1.9228196354882436, -0.477855203736465, -0.04300407740994387, -0.8773853506801337, 7.087332960805498, 0.0007809970168113358, -0.9988213825282609, 0.04853077217594226, 0.6724934095803233, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0255", (Matrix44f() << -0.8915679543596423, -0.001386094755753641, 0.45288482145054376, 1.624996141099339, -0.45268368372514173, -0.027229220128131493, -0.8912553237205653, 6.106243614848145, 0.013567064826213034, -0.9996282550591205, 0.023649237608420103, 0.7102452116611202, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0256", (Matrix44f() << -0.21325513599022855, 0.0918002113719689, 0.9726741325674552, 0.952001094409245, -0.975852184265223, -0.06818658101893331, -0.20751651653239916, 4.739223260523794, 0.047273263464482546, -0.9934401397975674, 0.104124575391246, 0.7951026191119098, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0257", (Matrix44f() << -0.1549290677612941, 0.11535604107864039, 0.981167655270637, 0.36356159608685756, -0.9877482015381511, -0.036907326706321575, -0.15162895367818358, 4.708094654754849, 0.01872095939753711, -0.9926383193399577, 0.11966073983215979, 0.8132150105892715, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0258", (Matrix44f() << -0.17085791129948205, 0.11200388531577564, 0.9789089354074509, -0.1624074990440136, -0.9849386942498872, -0.04615722830654249, -0.16662916564750896, 4.774909268497191, 0.026520609263469195, -0.9926351998338706, 0.11820328817366275, 0.8201480082484468, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0259", (Matrix44f() << -0.07747503273985785, 0.12793548861069162, 0.988751804072135, -1.0766076415000307, -0.9969871106064744, -0.013705900060543915, -0.07634690293707996, 4.766508902067389, 0.003784255080126785, -0.9916877830534537, 0.12861189818992064, 0.8255174235994314, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0260", (Matrix44f() << 0.24013065070126516, 0.11969612693870789, 0.9633328125781141, 0.5418007517332949, -0.9698491061566107, -0.012937894507293124, 0.2433625323934261, 3.74606728332141, 0.04159305087403847, -0.9927262704701587, 0.11298039669517386, 0.8740503765164084, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0261", (Matrix44f() << 0.23567901776126488, 0.09373548571092698, 0.9672998807534413, 0.17908162473941247, -0.9716095438602763, 0.001481347195914588, 0.2365855022821796, 3.5467430470650774, 0.020743550002621066, -0.9955960347093704, 0.09142341496721168, 0.8836599126391814, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0262", (Matrix44f() << 0.25915325252127136, 0.0698109411770812, 0.9633099315379327, -0.30631051482715654, -0.9653406297631676, -0.01322483263188672, 0.2606579604199908, 3.179035764062546, 0.03093639015944141, -0.9974725742063432, 0.06396407952963981, 0.9009175125307018, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0263", (Matrix44f() << 0.30700958495008057, 0.06170684099722498, 0.949703838321675, -0.9319540874395007, -0.9516901995975607, 0.014079023800890125, 0.3067369313903516, 2.7998924643377854, 0.005556864109753518, -0.9979950134459377, 0.06304819107879753, 0.9243939635574707, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0264", (Matrix44f() << 0.554917646010166, 0.05478335305649516, 0.8300995063089869, 1.0111094013900417, -0.8317537605314033, 0.017492252370507236, 0.5548690863157499, 2.597535575914537, 0.015877278998780317, -0.9983450332099089, 0.05527301942811729, 0.9371099503277649, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0265", (Matrix44f() << 0.5680650356326635, 0.07841013343333804, 0.8192398710186335, 0.618937716225213, -0.8227627834870478, 0.0310464254061865, 0.5675363614590198, 2.3292345299569095, 0.019066132284919022, -0.9964376400179111, 0.08214932839183615, 0.9579250956416638, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0266", (Matrix44f() << 0.6077956006473888, 0.07322645159236017, 0.7907100572402453, 0.20696803433038402, -0.7940933426491649, 0.05539442404217599, 0.6052662397204321, 1.936025331770247, 0.0005205707981985841, -0.9957757501426852, 0.09181712494854442, 0.9946733865653077, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0267", (Matrix44f() << 0.636040888106193, 0.0805913641819947, 0.7674353527668442, -0.3557646133788608, -0.7716311593850075, 0.0585499226768326, 0.6333697659508906, 1.4144880108857238, 0.006110852905646493, -0.9950260994435381, 0.09942695259809368, 1.0228004174126684, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0268", (Matrix44f() << 0.9430930220072908, 0.01813850328742619, 0.33203395389575413, 1.698594604760447, -0.33252840699740377, 0.05336653019056205, 0.9415821111274304, 1.765212547979507, -0.0006406098068029031, -0.9984102404091777, 0.056361169834945386, 0.9895578736864463, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0269", (Matrix44f() << 0.9349615335983763, 0.009399026098819398, 0.3546245747262397, 1.5190606372297182, -0.3545769726122905, 0.05589732178489545, 0.9333545199496163, 1.2728034687180867, -0.011049940473846883, -0.9983922814834205, 0.05559452391967092, 1.0110811262565849, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0270", (Matrix44f() << 0.9358190601389328, 0.020415882698365834, 0.3518890143416406, 1.3769246826800923, -0.35190172169712014, 0.11131373042082376, 0.9293946587356755, 0.7487886091057616, -0.02019566654723953, -0.9935755860292897, 0.1113538948544946, 1.048364848999652, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0271", (Matrix44f() << 0.9901235539597973, -0.001648934917791302, 0.14018783437822752, 2.325162328311808, -0.13968847120038283, 0.0735312956282233, 0.9874615332137929, 1.9835583304093896, -0.011936452895237842, -0.9972915469294181, 0.07257473055690929, 0.9701842706807314, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0272", (Matrix44f() << 0.9946962133040974, 0.010103068790220687, 0.10235903105984268, 2.295302822556687, -0.1027981082772251, 0.06414340784303152, 0.9926319419426852, 1.3874586962912916, 0.00346297171712823, -0.9978895486131232, 0.06484178124931311, 0.9951996281861197, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0273", (Matrix44f() << 0.9974508300035928, -0.011782813148769573, 0.07037760325163872, 2.3377362715711114, -0.06976763132896514, 0.04597603212755071, 0.9965032273347397, 0.7422934805755375, -0.014977294277988492, -0.9988730498837716, 0.045036772442115944, 1.0260056097205816, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0274", (Matrix44f() << 0.9146562927038853, -0.03384523269659293, -0.4028130663730981, 3.3871950793976766, 0.40385207023113096, 0.0332906717345922, 0.9142183746487976, 2.004893771170797, -0.017532016062458328, -0.9988724800489666, 0.04411798968235819, 0.9544069703700668, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0275", (Matrix44f() << 0.9069365461983947, -0.08801158435980184, -0.41197094823325175, 3.6808786850927224, 0.41998095823043574, 0.1125363653908527, 0.9005284899371377, 1.5484213789343557, -0.03289522599971413, -0.9897421520189458, 0.1390265320841087, 1.0065601810664955, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0276", (Matrix44f() << 0.8989327752826862, -0.08011550984168282, -0.43069870049185754, 3.9171975548421982, 0.43740982659195543, 0.1095130206760948, 0.8925690684217065, 1.1426587811437028, -0.02434151029338897, -0.9907514337033302, 0.1334881548731287, 1.0159631305007224, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0277", (Matrix44f() << 0.8904812534152023, -0.06290206713750933, -0.4506511591751631, 4.4281333075668945, 0.45496698390404994, 0.10797767512695056, 0.8839377043838726, 0.5818788873814762, -0.006941244365530708, -0.9921613536234956, 0.12477045925478925, 1.0326458551447648, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0278", (Matrix44f() << 0.6126233740485165, -0.09565590190729975, -0.7845651980554023, 4.264832501843322, 0.7889275873571591, 0.01396104776481161, 0.6143275600623179, 2.762681150105235, -0.047810704619611566, -0.9953165514426101, 0.08401844409513042, 0.9237321780043316, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0279", (Matrix44f() << 0.5367443834367219, -0.14167438521729064, -0.8317654930462287, 4.907244230548854, 0.8432191844545438, 0.055274932382763674, 0.534720570782437, 2.429060775526923, -0.029780426742194104, -0.9883688837794236, 0.14913106906231532, 0.9432535132655481, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0280", (Matrix44f() << 0.5169147269094998, -0.06609151736853444, -0.8534817376112989, 5.7483013610236195, 0.8560356600581809, 0.04160239547394314, 0.5152399338168423, 2.2368077057084874, 0.0014538957430750463, -0.9969459122854932, 0.07808158659001445, 0.9349437163781719, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0281", (Matrix44f() << 0.12750037571696407, -0.08304554134474032, -0.9883557518701411, 4.509450484261062, 0.9892533808338988, -0.061251849945298135, 0.1327627936847516, 4.10311206643657, -0.07156397627811248, -0.9946615750802068, 0.07434344865708122, 0.8412671530825534, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0282", (Matrix44f() << 0.14216502338347742, -0.13313047526887856, -0.9808493170110575, 5.293520706520319, 0.9889635100313631, -0.0226581093085993, 0.14641648100198776, 4.151109181599113, -0.04171668674309289, -0.9908394858084947, 0.128439991474371, 0.8307327480427971, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0283", (Matrix44f() << 0.12988718259506088, -0.12871409145786378, -0.9831388520741585, 6.097507901270831, 0.9905625715151782, -0.026917699015262486, 0.13439207340078158, 4.272646832427067, -0.04376198933726307, -0.991316357244195, 0.12400309733770709, 0.8249243161162441, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0284", (Matrix44f() << -0.28753698515253123, -0.0991933667101253, -0.9526191044536655, 4.784679809335999, 0.9566443616652869, -0.07794191463365004, -0.2806361046573599, 5.54335670213782, -0.04641171687633298, -0.9920109545483615, 0.11730395812861406, 0.747345972895655, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0285", (Matrix44f() << -0.3274595251433477, -0.09920603068820871, -0.9396427102191465, 5.47670276706202, 0.944048295922093, -0.07569623338214793, -0.3210029520399277, 5.989137635276069, -0.03928198517750384, -0.9921835736026099, 0.11844273685485655, 0.7154821866313059, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0286", (Matrix44f() << -0.365759660471144, -0.06615352503370683, -0.9283553101575106, 6.359341869004608, 0.929658241082082, -0.07336051190577536, -0.36104541276838403, 6.566586827044878, -0.0442201940317215, -0.9951090123290701, 0.08833248565086106, 0.6811861786032352, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0287", (Matrix44f() << -0.8770474726845832, -0.004428146745183816, -0.48038330755136427, 3.8846809202777566, 0.47977917271077525, -0.059045942879086405, -0.875400206798287, 6.6707030795748885, -0.024488284761277308, -0.9982454448410585, 0.05391062755642713, 0.675284629407318, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0288", (Matrix44f() << -0.829724154983588, 0.005798975357004787, -0.558143528603154, 4.228867442947464, 0.5577485427319462, -0.030405284094238937, -0.8294528809881482, 7.350369034315288, -0.021780489369186726, -0.9995208304902692, 0.021993628597420455, 0.6176715445784916, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0289", (Matrix44f() << -0.8811785673446931, 0.004803541455402115, -0.472759197099158, 4.404372973470721, 0.47256270005084167, -0.02161517620239345, -0.8810319396471377, 8.321235945333736, -0.014450846792228661, -0.999754825018227, 0.01677685547895769, 0.5545485164526601, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0290", (Matrix44f() << -0.9881090077196236, 0.02633468522456811, -0.15148291394564448, 3.1437669987751877, 0.1519723652753401, 0.01768933126315066, -0.9882264354651119, 7.199202378242682, -0.02334500066307879, -0.9994966592808529, -0.021481131964014796, 0.6291443112736357, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0291", (Matrix44f() << -0.9800747857965472, -0.059470731589455046, -0.18951687610887616, 3.2340010746129964, 0.19799021875571948, -0.3689458670103908, -0.9081182855184743, 7.985089372810028, -0.015915009359544784, -0.9275463219161435, 0.37336916473768894, 0.6448969061639244, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0292", (Matrix44f() << -0.9781514900235468, -0.02787521463255879, -0.20601610367615444, 3.22712973675177, 0.20736483803317776, -0.20144053717900917, -0.9572990827993653, 8.01116885787143, -0.014815077191466974, -0.979104020209406, 0.2028197009602122, 0.614665596597452, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0293", (Matrix44f() << -0.9735732195503698, 0.021338777934910288, -0.2273759941827017, 3.2664831139965083, 0.22746045532514372, 0.0015859312802107572, -0.9737860268484307, 8.135358654958088, -0.020418801081493826, -0.9997710444787942, -0.0063977483676170175, 0.5713218571410099, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0294", (Matrix44f() << -0.9721899561626983, 0.0640476079056789, -0.22526560558134764, 3.27307004807143, 0.23361590576148658, 0.1976946916549413, -0.9520191266286081, 8.20392660131393, -0.016440733305147757, -0.9781690614679133, -0.20715933354635727, 0.5147096151181934, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0295", (Matrix44f() << -0.9994629962000459, 0.03142951844159045, -0.009268473302372791, 2.3173213915004878, 0.0027161922265016352, -0.20241619570492678, -0.9792958215044795, 9.597284816008834, -0.03265488518760644, -0.978795110882188, 0.20222212882498755, 0.5349360616207682, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0296", (Matrix44f() << -0.9982936165209545, 0.014724693075243076, 0.05650697857215043, 2.1708050355049777, -0.05765977110804186, -0.09559764718734848, -0.9937486808283127, 10.152433308905175, -0.009230710117961038, -0.9953111439475011, 0.096283543373907, 0.4770603689505097, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0297", (Matrix44f() << -0.9466709101164594, 0.095989925900455, 0.3075713284181404, -0.14759148786506454, -0.32145492492710265, -0.21640481122353036, -0.9218653312276253, 2.198464791598938, -0.02192986957064002, -0.9715734104044497, 0.23572057401864863, 0.9601153394896551, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0298", (Matrix44f() << -0.9994601190232985, 0.013242610049919291, 0.03006831822699327, 0.6915706629137781, -0.03167692245894259, -0.1454925204020622, -0.9888521118400798, 2.1779757236711372, -0.008720267511040795, -0.9892707211810735, 0.14583345688974986, 0.9298401913791998, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0299", (Matrix44f() << -0.999753022875778, 0.007067553380288926, -0.021069953487388497, 2.0991828801173638, 0.02048075523557961, -0.07504798849576405, -0.9969695773130292, 1.2363507665941027, -0.008627393333111662, -0.9971548771940878, 0.07488470452849011, 0.9721207073251864, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0300", (Matrix44f() << -0.4097497091201549, -0.027892789970026026, -0.9117714451240709, 3.3451818179335686, 0.9121928545732043, -0.009174616805370428, -0.40965842170284206, 0.3032506667778976, 0.0030613626929175625, -0.9995688163774232, 0.029202900272058182, 1.0117083837356635, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0301", (Matrix44f() << -0.02318511622448331, -0.07304292693170078, -0.9970592666491332, 4.739940603499789, 0.9994750243406891, 0.020882259533271934, -0.024771091133899806, -0.025202802734166654, 0.02263020337593291, -0.9971101554301989, 0.07252042355866807, 1.0243574340536492, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0302", (Matrix44f() << 0.7446914112534571, -0.10122890111911241, -0.6596873589690435, 4.800760100968752, 0.666843707499911, 0.07218360655129742, 0.7416933306380884, 1.3353252264072841, -0.027462188061182256, -0.9922410173558965, 0.1212583675604608, 0.03067962354250516, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0303", (Matrix44f() << 0.48834195700470256, -0.1827406060940159, -0.8533041684611701, 5.578650267274495, 0.8708673312342511, 0.03954260695127831, 0.48992496734135704, 2.4257922080928416, -0.05578731412920325, -0.9823656412557844, 0.17845313800088067, -0.02691862767825769, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0304", (Matrix44f() << 0.19234440273387124, -0.1256231301463079, -0.9732535434865851, 6.017698651229272, 0.9800185173911413, -0.026618363258552047, 0.1971171436174565, 3.814332832192586, -0.05066888894992312, -0.9917208739911042, 0.11799310057329981, -0.12260686570576329, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0305", (Matrix44f() << -0.28479252718292164, -0.15440785091621592, -0.9460715787064954, 5.968292768542781, 0.957051509354237, -0.10167916804469974, -0.27150277204572854, 5.861237116309099, -0.05427361148423599, -0.9827611929462687, 0.17673373400481507, -0.22843882858702527, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0306", (Matrix44f() << -0.5934966104555579, -0.12756364809365472, -0.794663003456687, 5.6825595557941915, 0.8034438931946009, -0.15196214766916394, -0.575660851686197, 7.339682625984099, -0.047325298372714854, -0.9801199015226726, 0.19267925361366778, -0.3072606399463996, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0307", (Matrix44f() << -0.9431552836234568, -0.06383862664461026, -0.3261636716761798, 4.032566827710732, 0.33212171695916104, -0.2175939973739479, -0.917795193619429, 8.946026718918628, -0.01238047241649532, -0.973949424793175, 0.2264271225975102, -0.3954091107177877, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0308", (Matrix44f() << -0.9735136244611152, -0.04695900748104477, -0.22375449627879668, 3.495309513703634, 0.22847938410256666, -0.2352241378972065, -0.9447045972104866, 7.9438232191475215, -0.008270068240018963, -0.9708060859754183, 0.23972306815238742, -0.33705202804829787, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0309", (Matrix44f() << -0.9517710850806755, -0.06266926995923015, -0.3003404138758732, 4.193340801713251, 0.30608162071102396, -0.2613195033729508, -0.9154376869125649, 10.697787721402566, -0.021114996264892907, -0.9632158012406626, 0.26789825899591435, -0.5055511231616856, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0310", (Matrix44f() << -0.9815727095215406, 0.016630723410453997, 0.1903639539445065, 1.6440425964389016, -0.1899365949020683, -0.194156391390711, -0.9624070789427647, 9.065051317824144, 0.020954852410572822, -0.9808296053448743, 0.19373739814364443, -0.4075597891751747, 0.0, 0.0, 0.0, 1.0).finished() },
        { "IMG_0311", (Matrix44f() << -0.7316354275393222, 0.09925911437923507, 0.6744310412355016, -0.2511662495766473, -0.6807359752712681, -0.15887117887307953, -0.7150933369113109, 6.851734952082619, 0.036168123269374526, -0.9822970918902936, 0.18380503290999278, -0.2627667395608611, 0.0, 0.0, 0.0, 1.0).finished() },
    };

    //

    TriangleMesh mesh;
    WavefrontFile obj("scene.obj");
    obj.read(mesh);

    //

    RadarFrame frame;

    auto scene = hussar::make_shared<Scene>();
    auto integrator = hussar::make_shared<PathTracer>();
    integrator->produceDebugImage = true;
    integrator->configureFrame(frameConfig);

    gpu::Backend backend { mesh, *integrator };

    for (auto &location : locations) {
        Vector3f position { location.transform.block<3, 1>(0, 3) };
        Matrix33f rotation { location.transform.block<3, 3>(0, 0) };

        scene->rx = NFAntenna { position, rotation, AWRAngularDistribution() };
        scene->tx = scene->rx;
        scene->rfConfig = rf;

        {
            Timer t { "simulation of " + location.label };
            integrator->run(backend, *scene, 4*1024*1024);
            frame = integrator->fetchFrame();
        }

        std::string name = "sim/" + location.label;
        integrator->saveDebugImage(name);
        saveFrame(frame, name);
    }
}
